import{_ as w,a as x,i as v,h as y,b as _,p as b,r as u,j as e,L as p,C as D}from"./index-8bb4ccf4.js";import{d as E,u as R,L as M}from"./LocationOn-9009a2e9.js";import{u as C,S as I}from"./searchContext-b5903780.js";import{a as L}from"./axios-b8a0d269.js";import{Q as z,u as O,C as $}from"./constants-a23ac1b2.js";import{u as k,d as F,a as S,b as j}from"./useFormatDate-4aae59ad.js";import{C as q,f as A,A as H}from"./CloudinaryImage-f7796968.js";import{H as Q}from"./Header-aee7db4c.js";var T=function(t){w(i,t);function i(r,a){return t.call(this,r,a)||this}var n=i.prototype;return n.bindMethods=function(){t.prototype.bindMethods.call(this),this.fetchNextPage=this.fetchNextPage.bind(this),this.fetchPreviousPage=this.fetchPreviousPage.bind(this)},n.setOptions=function(a,c){t.prototype.setOptions.call(this,x({},a,{behavior:v()}),c)},n.getOptimisticResult=function(a){return a.behavior=v(),t.prototype.getOptimisticResult.call(this,a)},n.fetchNextPage=function(a){var c;return this.fetch({cancelRefetch:(c=a==null?void 0:a.cancelRefetch)!=null?c:!0,throwOnError:a==null?void 0:a.throwOnError,meta:{fetchMore:{direction:"forward",pageParam:a==null?void 0:a.pageParam}}})},n.fetchPreviousPage=function(a){var c;return this.fetch({cancelRefetch:(c=a==null?void 0:a.cancelRefetch)!=null?c:!0,throwOnError:a==null?void 0:a.throwOnError,meta:{fetchMore:{direction:"backward",pageParam:a==null?void 0:a.pageParam}}})},n.createResult=function(a,c){var o,d,f,g,l,h,s=a.state,m=t.prototype.createResult.call(this,a,c);return x({},m,{fetchNextPage:this.fetchNextPage,fetchPreviousPage:this.fetchPreviousPage,hasNextPage:y(c,(o=s.data)==null?void 0:o.pages),hasPreviousPage:_(c,(d=s.data)==null?void 0:d.pages),isFetchingNextPage:s.isFetching&&((f=s.fetchMeta)==null||(g=f.fetchMore)==null?void 0:g.direction)==="forward",isFetchingPreviousPage:s.isFetching&&((l=s.fetchMeta)==null||(h=l.fetchMore)==null?void 0:h.direction)==="backward"})},i}(z);function U(t,i,n){var r=b(t,i,n);return O(r,T)}function B(t){const[i,n]=u.useState(null),r=u.useRef();return{ref:u.useCallback(c=>{if(r.current&&(r.current.disconnect(),r.current=null),c===null){n(null);return}r.current=new IntersectionObserver(([o])=>{n(o)},t),r.current.observe(c)},[t==null?void 0:t.rootMargin,t==null?void 0:t.root,t==null?void 0:t.threshold]),entry:i}}function G(t){return U({queryKey:["events",t.query],staleTime:1e3*60*5,queryFn:async({pageParam:i=1})=>{const{data:n}=await L.get("api/events"+t.query+"&page="+i);return n},onError(i){console.error("Error when fetching events: ",i)},onSuccess(i){console.log("Succesfully fetched events: ",i)},getNextPageParam(i,n){if(!(n.length===0||n[n.length-1].length===0))return n.length+1}})}function P(t){const i=new q(t.imageID,{cloudName:$}).resize(A().gravity("auto").width(450).height(300)),n=t.distance!=null?e.jsxs("div",{className:"flex w-fit items-center rounded-full bg-secondary-light p-1 mb-1",children:[e.jsx(E,{style:{color:"white"}}),e.jsxs("h6",{className:"p-1 text-white",children:[t.distance," km"]})]}):null,r=k(t.startDate,t.endDate),a=e.jsxs("div",{className:"flex items-center rounded-full bg-secondary-light p-1",children:[e.jsx(F,{style:{color:"white"}}),e.jsx("h6",{className:"p-1 text-white",children:r.startDate===r.endDate?r.startDate:r.startDate+"-"+r.endDate})]}),c=e.jsxs("div",{className:"flex items-center rounded-full bg-secondary-light p-1",children:[e.jsx(S,{style:{color:"white"}}),e.jsxs("h6",{className:"p-1 text-white",children:[r.startTime," - ",r.endTime]})]}),d=encodeURI(t.organization.replace(/\s/g,"-"))+"/"+t._id;return e.jsx("div",{className:"m-auto shadow-lg max-w-[350px] md:max-w-none md:w-auto rounded-2xl bg-white h-[100%] cursor-pointer mb-6",children:e.jsx(p,{to:d,children:e.jsxs("div",{className:"md:grid grid-flow-col grid-cols-[350px,1fr] rounded-2xl items-center",children:[e.jsx(H,{className:"rounded-2xl",cldImg:i}),e.jsxs("div",{className:"m-4",children:[n,t.organization,e.jsx("h2",{className:"text-black p-0",children:t.title}),e.jsxs("div",{className:"flex gap-2 pt-2 pb-2",children:[a,c]}),e.jsx("p",{className:"text-black",children:t.extract}),e.jsx("br",{})]})]})})})}const N=e.jsx("div",{className:"grid justify-center pt-4","aria-busy":!0,children:e.jsx(D,{size:50,color:"info"})});function K(){const t=C(),i=R(),{isLoading:n,data:r,isError:a,fetchNextPage:c,isFetchingNextPage:o,hasNextPage:d}=G({query:t.query,page:1}),f=u.useRef(null),{ref:g,entry:l}=B({root:f.current,threshold:0});return u.useEffect(()=>{i.locationOn||i.getLocation()},[]),u.useEffect(()=>{l!=null&&l.isIntersecting&&d&&c()},[l]),n?N:a?e.jsx("div",{children:e.jsx("h2",{className:"text-center pt-4",children:"Error when fetching events. Please try again"})}):e.jsxs(e.Fragment,{children:[e.jsx("div",{children:r==null?void 0:r.pages.map(h=>h.map((s,m)=>h.length-1===m?e.jsx("div",{ref:g,children:e.jsx(P,{_id:s._id,imageID:s.image_id,title:s.title,extract:s.extract,organization:s.organization.organization_name,distance:i.coords.latitude?Math.round(j(i.coords.longitude,i.coords.latitude,s.address.coordinates[0],s.address.coordinates[1])):null,startDate:s.start_date,endDate:s.end_date})},s._id):e.jsx("div",{children:e.jsx(P,{_id:s._id,imageID:s.image_id,title:s.title,extract:s.extract,organization:s.organization.organization_name,distance:i.coords.latitude?Math.round(j(i.coords.longitude,i.coords.latitude,s.address.coordinates[0],s.address.coordinates[1])):null,startDate:s.start_date,endDate:s.end_date})},s._id)))}),e.jsx("div",{className:"w-[100%]",children:o?N:e.jsx("div",{className:"h-1 rounded-sm m-6 bg-slate-400"})})]})}function ae(){return e.jsx(I,{children:e.jsxs(M,{children:[e.jsx(Q,{home:!0}),e.jsx("main",{children:e.jsx("section",{className:"pt-6",children:e.jsx(K,{})})}),e.jsx("footer",{children:e.jsx("div",{className:" pb-16"})})]})})}export{ae as default};
