import{p as w,_ as m,q as v,s as y,t as _,v as b,r as u,w as D,j as t,L as E,o as R,C as M}from"./index-61a7dcf4.js";import{Q as p,a as I,d as z,u as O}from"./LocationOn-8db10a12.js";import{a as $}from"./axios-b8a0d269.js";import{u as C,d as L,a as k,c as P}from"./useFormatDate-5d1358ae.js";import{C as F,f as q,A}from"./CloudinaryImage-f7796968.js";var S=function(e){w(i,e);function i(r,a){return e.call(this,r,a)||this}var n=i.prototype;return n.bindMethods=function(){e.prototype.bindMethods.call(this),this.fetchNextPage=this.fetchNextPage.bind(this),this.fetchPreviousPage=this.fetchPreviousPage.bind(this)},n.setOptions=function(a,c){e.prototype.setOptions.call(this,m({},a,{behavior:v()}),c)},n.getOptimisticResult=function(a){return a.behavior=v(),e.prototype.getOptimisticResult.call(this,a)},n.fetchNextPage=function(a){var c;return this.fetch({cancelRefetch:(c=a==null?void 0:a.cancelRefetch)!=null?c:!0,throwOnError:a==null?void 0:a.throwOnError,meta:{fetchMore:{direction:"forward",pageParam:a==null?void 0:a.pageParam}}})},n.fetchPreviousPage=function(a){var c;return this.fetch({cancelRefetch:(c=a==null?void 0:a.cancelRefetch)!=null?c:!0,throwOnError:a==null?void 0:a.throwOnError,meta:{fetchMore:{direction:"backward",pageParam:a==null?void 0:a.pageParam}}})},n.createResult=function(a,c){var o,d,f,g,l,h,s=a.state,x=e.prototype.createResult.call(this,a,c);return m({},x,{fetchNextPage:this.fetchNextPage,fetchPreviousPage:this.fetchPreviousPage,hasNextPage:y(c,(o=s.data)==null?void 0:o.pages),hasPreviousPage:_(c,(d=s.data)==null?void 0:d.pages),isFetchingNextPage:s.isFetching&&((f=s.fetchMeta)==null||(g=f.fetchMore)==null?void 0:g.direction)==="forward",isFetchingPreviousPage:s.isFetching&&((l=s.fetchMeta)==null||(h=l.fetchMore)==null?void 0:h.direction)==="backward"})},i}(p);function Q(e,i,n){var r=b(e,i,n);return I(r,S)}function T(e){const[i,n]=u.useState(null),r=u.useRef();return{ref:u.useCallback(c=>{if(r.current&&(r.current.disconnect(),r.current=null),c===null){n(null);return}r.current=new IntersectionObserver(([o])=>{n(o)},e),r.current.observe(c)},[e==null?void 0:e.rootMargin,e==null?void 0:e.root,e==null?void 0:e.threshold]),entry:i}}function U(e){return Q({queryKey:["events",e.query],staleTime:1e3*60*5,queryFn:async({pageParam:i=1})=>{const{data:n}=await $.get("api/events"+e.query+"&page="+i);return n},onError(i){console.error("Error when fetching events: ",i)},onSuccess(i){console.log("Succesfully fetched events: ",i)},getNextPageParam(i,n){if(!(n.length===0||n[n.length-1].length===0))return n.length+1}})}function j(e){const i=new F(e.imageID,{cloudName:D}).resize(q().gravity("auto").width(450).height(300)),n=e.distance!=null?t.jsxs("div",{className:"flex w-fit items-center rounded-full bg-secondary-light p-1 mb-1",children:[t.jsx(z,{style:{color:"white"}}),t.jsxs("h6",{className:"p-1 text-white",children:[e.distance," km"]})]}):null,r=C(e.startDate,e.endDate),a=t.jsxs("div",{className:"flex items-center rounded-full bg-secondary-light p-1",children:[t.jsx(L,{style:{color:"white"}}),t.jsx("h6",{className:"p-1 text-white",children:r.startDate===r.endDate?r.startDate:r.startDate+"-"+r.endDate})]}),c=t.jsxs("div",{className:"flex items-center rounded-full bg-secondary-light p-1",children:[t.jsx(k,{style:{color:"white"}}),t.jsxs("h6",{className:"p-1 text-white",children:[r.startTime," - ",r.endTime]})]}),d=encodeURI(e.organization.replace(/\s/g,"-"))+"/"+e._id;return t.jsx("div",{className:"m-auto shadow-lg max-w-[350px] md:max-w-none md:w-auto rounded-2xl bg-white h-[100%] cursor-pointer mb-6",children:t.jsx(E,{to:d,children:t.jsxs("div",{className:"md:grid grid-flow-col grid-cols-[350px,1fr] rounded-2xl items-center",children:[t.jsx(A,{className:"rounded-2xl",cldImg:i}),t.jsxs("div",{className:"m-4",children:[n,e.organization,t.jsx("h2",{className:"text-black p-0",children:e.title}),t.jsxs("div",{className:"flex gap-2 pt-2 pb-2",children:[a,c]}),t.jsx("p",{className:"text-black",children:e.extract}),t.jsx("br",{})]})]})})})}const N=t.jsx("div",{className:"grid justify-center pt-4","aria-busy":!0,children:t.jsx(M,{size:50,color:"info"})});function J(){const e=R(),i=O(),{isLoading:n,data:r,isError:a,fetchNextPage:c,isFetchingNextPage:o,hasNextPage:d}=U({query:e.query,page:1}),f=u.useRef(null),{ref:g,entry:l}=T({root:f.current,threshold:0});return u.useEffect(()=>{i.locationOn||i.getLocation()},[]),u.useEffect(()=>{l!=null&&l.isIntersecting&&d&&c()},[l]),n?N:a?t.jsx("div",{children:t.jsx("h2",{className:"text-center pt-4",children:"Error when fetching events. Please try again"})}):t.jsxs(t.Fragment,{children:[t.jsx("div",{children:r==null?void 0:r.pages.map(h=>h.map((s,x)=>h.length-1===x?t.jsx("div",{ref:g,children:t.jsx(j,{_id:s._id,imageID:s.image_id,title:s.title,extract:s.extract,organization:s.organization.organization_name,distance:i.coords.latitude?Math.round(P(i.coords.longitude,i.coords.latitude,s.address.coordinates[0],s.address.coordinates[1])):null,startDate:s.start_date,endDate:s.end_date})},s._id):t.jsx("div",{children:t.jsx(j,{_id:s._id,imageID:s.image_id,title:s.title,extract:s.extract,organization:s.organization.organization_name,distance:i.coords.latitude?Math.round(P(i.coords.longitude,i.coords.latitude,s.address.coordinates[0],s.address.coordinates[1])):null,startDate:s.start_date,endDate:s.end_date})},s._id)))}),t.jsx("div",{className:"w-[100%]",children:o?N:t.jsx("div",{className:"h-1 rounded-sm m-6 bg-slate-400"})})]})}export{J as E};
